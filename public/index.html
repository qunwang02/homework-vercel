<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åŠŸè¯¾æ”¶é›†ç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
        body { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); min-height: 100vh; padding: 20px; }
        .container { max-width: 1000px; margin: 0 auto; background: white; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); overflow: hidden; }
        .header { background: linear-gradient(90deg, #4CAF50, #2E7D32); color: white; padding: 25px; text-align: center; }
        .header h1 { font-size: 32px; margin-bottom: 10px; }
        .content { padding: 30px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; }
        @media (max-width: 768px) { .grid { grid-template-columns: 1fr; } }
        .form-group { margin-bottom: 20px; }
        label { display: block; margin-bottom: 8px; font-weight: 600; color: #333; }
        input, textarea, select { width: 100%; padding: 12px; border: 2px solid #ddd; border-radius: 8px; font-size: 16px; }
        button { padding: 12px 24px; border: none; border-radius: 8px; font-size: 16px; cursor: pointer; margin: 5px; transition: all 0.3s; }
        button:hover { opacity: 0.9; transform: translateY(-2px); }
        .btn-primary { background: #4CAF50; color: white; }
        .btn-secondary { background: #2196F3; color: white; }
        .btn-danger { background: #f44336; color: white; }
        .btn-success { background: #2E7D32; color: white; }
        .classic-section { background: #f8f9fa; border-radius: 10px; padding: 20px; margin-bottom: 15px; }
        .classic-title { font-weight: bold; color: #2E7D32; margin-bottom: 10px; }
        .radio-group { display: flex; gap: 15px; flex-wrap: wrap; }
        .radio-option { display: flex; align-items: center; }
        .radio-option input { width: auto; margin-right: 5px; }
        .alert { padding: 15px; border-radius: 8px; margin: 15px 0; display: none; }
        .alert-success { background: #d4edda; color: #155724; }
        .alert-error { background: #f8d7da; color: #721c24; }
        .alert-info { background: #d1ecf1; color: #0c5460; }
        .stats { background: #e3f2fd; padding: 20px; border-radius: 10px; margin-top: 20px; }
        .loading { display: none; text-align: center; padding: 20px; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #3498db; border-radius: 50%; width: 40px; height: 40px; animation: spin 2s linear infinite; margin: 0 auto 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .success-icon { font-size: 48px; color: #4CAF50; text-align: center; margin: 20px 0; }
        .cloud-status { background: #e8f5e9; padding: 10px; border-radius: 8px; margin-bottom: 20px; text-align: center; }
        .cloud-status.online { background: #e8f5e9; color: #2E7D32; }
        .cloud-status.offline { background: #ffebee; color: #c62828; }
        .data-table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        .data-table th, .data-table td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        .data-table th { background: #f8f9fa; font-weight: 600; }
        .tabs { display: flex; border-bottom: 2px solid #ddd; margin-bottom: 20px; }
        .tab { padding: 10px 20px; cursor: pointer; border: none; background: none; font-size: 16px; }
        .tab.active { border-bottom: 3px solid #4CAF50; font-weight: bold; color: #4CAF50; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .data-actions { margin-bottom: 15px; }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>åŠŸè¯¾æ”¶é›†ç³»ç»Ÿ</h1>
            <p>äº‘ç«¯å­˜å‚¨ç‰ˆ - æ•°æ®è‡ªåŠ¨ä¿å­˜åˆ°äº‘ç«¯</p>
        </div>
        
        <div class="content">
            <div class="tabs">
                <button class="tab active" data-tab="submit">æäº¤åŠŸè¯¾</button>
                <button class="tab" data-tab="data">æœ¬åœ°æ•°æ®ç®¡ç†</button>
                <button class="tab" data-tab="cloud">äº‘ç«¯çŠ¶æ€</button>
            </div>
            
            <!-- æäº¤åŠŸè¯¾æ ‡ç­¾é¡µ -->
            <div id="submit-tab" class="tab-content active">
                <div class="form-group">
                    <div>
                        <div id="cloudStatus" class="cloud-status online">
                            <span id="statusIcon">ğŸŒ</span> <span id="statusText">äº‘ç«¯è¿æ¥æ­£å¸¸</span>
                        </div>
                        
                        <h2>æäº¤åŠŸè¯¾</h2>
                        
                        <form id="homeworkForm">
                            <div class="form-group">
                                <label>æ—¥æœŸ *</label>
                                <input type="date" id="date" required>
                            </div>
                            <div class="form-group">
                                <label>å§“å *</label>
                                <input type="text" id="name" required placeholder="è¯·è¾“å…¥æ‚¨çš„å§“å">
                            </div>
                            <!-- ç§»é™¤äº†è”ç³»æ–¹å¼å­—æ®µ -->
                            
                            <div class="form-group">
                                <label>ä¹å­—ç¦…ï¼ˆå£°ï¼‰</label>
                                <input type="number" id="nineWord" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>ç¤¼ä½›æ‹œå¿æ–‡ï¼ˆéï¼‰</label>
                                <input type="number" id="buddhaWorship" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>é™ç¦…ï¼ˆåˆ†é’Ÿï¼‰</label>
                                <input type="number" id="quietZen" min="0" value="0">
                            </div>
                            <div class="form-group">
                                <label>åŠ¨ç¦…ï¼ˆåˆ†é’Ÿï¼‰</label>
                                <input type="number" id="activeZen" min="0" value="0">
                            </div>
                            
                            <!-- ç»å…¸è¯µè¯»éƒ¨åˆ† - å¢åŠ è¯å¸ˆä½›ç» -->
                            <div class="form-group">
                                <label>ç»å…¸è¯µè¯»ï¼ˆéï¼‰</label>
                                
                                <div class="classic-section">
                                    <div class="classic-title">é‡‘åˆšèˆ¬è‹¥æ³¢ç½—èœœç»</div>
                                    <div class="radio-group">
                                        <label class="radio-option"><input type="radio" name="diamond" value="0" checked> 0é</label>
                                        <label class="radio-option"><input type="radio" name="diamond" value="1"> 1é</label>
                                        <label class="radio-option"><input type="radio" name="diamond" value="2"> 2é</label>
                                        <label class="radio-option"><input type="radio" name="diamond" value="3"> 3é</label>
                                        <label class="radio-option"><input type="radio" name="diamond" value="4"> 4é</label>
                                    </div>
                                </div>
                                
                                <div class="classic-section">
                                    <div class="classic-title">ä½›è¯´é˜¿å¼¥é™€ç»</div>
                                    <div class="radio-group">
                                        <label class="radio-option"><input type="radio" name="amitabha" value="0" checked> 0é</label>
                                        <label class="radio-option"><input type="radio" name="amitabha" value="1"> 1é</label>
                                        <label class="radio-option"><input type="radio" name="amitabha" value="2"> 2é</label>
                                        <label class="radio-option"><input type="radio" name="amitabha" value="3"> 3é</label>
                                        <label class="radio-option"><input type="radio" name="amitabha" value="4"> 4é</label>
                                    </div>
                                </div>
                                
                                <div class="classic-section">
                                    <div class="classic-title">è§‚ä¸–éŸ³è©è¨æ™®é—¨å“</div>
                                    <div class="radio-group">
                                        <label class="radio-option"><input type="radio" name="guanyin" value="0" checked> 0é</label>
                                        <label class="radio-option"><input type="radio" name="guanyin" value="1"> 1é</label>
                                        <label class="radio-option"><input type="radio" name="guanyin" value="2"> 2é</label>
                                        <label class="radio-option"><input type="radio" name="guanyin" value="3"> 3é</label>
                                        <label class="radio-option"><input type="radio" name="guanyin" value="4"> 4é</label>
                                    </div>
                                </div>
                                
                                <div class="classic-section">
                                    <div class="classic-title">æ™®è´¤è¡Œæ„¿å“</div>
                                    <div class="radio-group">
                                        <label class="radio-option"><input type="radio" name="puxian" value="0" checked> 0é</label>
                                        <label class="radio-option"><input type="radio" name="puxian" value="1"> 1é</label>
                                        <label class="radio-option"><input type="radio" name="puxian" value="2"> 2é</label>
                                        <label class="radio-option"><input type="radio" name="puxian" value="3"> 3é</label>
                                        <label class="radio-option"><input type="radio" name="puxian" value="4"> 4é</label>
                                    </div>
                                </div>
                                
                                <div class="classic-section">
                                    <div class="classic-title">åœ°è—è©è¨æœ¬æ„¿ç»</div>
                                    <div class="radio-group">
                                        <label class="radio-option"><input type="radio" name="dizang" value="0" checked> 0é</label>
                                        <label class="radio-option"><input type="radio" name="dizang" value="1"> 1é</label>
                                        <label class="radio-option"><input type="radio" name="dizang" value="2"> 2é</label>
                                        <label class="radio-option"><input type="radio" name="dizang" value="3"> 3é</label>
                                        <label class="radio-option"><input type="radio" name="dizang" value="4"> 4é</label>
                                    </div>
                                </div>
                                
                                <!-- æ–°å¢ï¼šè¯å¸ˆä½›ç» -->
                                <div class="classic-section">
                                    <div class="classic-title">è¯å¸ˆç‰ç’ƒå…‰å¦‚æ¥æœ¬æ„¿åŠŸå¾·ç»</div>
                                    <div class="radio-group">
                                        <label class="radio-option"><input type="radio" name="yaoshi" value="0" checked> 0é</label>
                                        <label class="radio-option"><input type="radio" name="yaoshi" value="1"> 1é</label>
                                        <label class="radio-option"><input type="radio" name="yaoshi" value="2"> 2é</label>
                                        <label class="radio-option"><input type="radio" name="yaoshi" value="3"> 3é</label>
                                        <label class="radio-option"><input type="radio" name="yaoshi" value="4"> 4é</label>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="form-group">
                                <label>å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰</label>
                                <textarea id="remark" rows="3" placeholder="å…¶ä»–åŠŸè¯¾å†…å®¹ã€æ„Ÿæƒ³æˆ–ç‰¹æ®Šè¯´æ˜..."></textarea>
                            </div>
                            
                            <div class="form-group">
                                <label>å­˜å‚¨æ–¹å¼</label>
                                <select id="storageMode">
                                    <option value="both">äº‘ç«¯+æœ¬åœ°ï¼ˆæ¨èï¼‰</option>
                                    <option value="cloud">ä»…äº‘ç«¯</option>
                                    <option value="local">ä»…æœ¬åœ°</option>
                                </select>
                            </div>
                            
                            <button type="submit" class="btn-primary">æäº¤</button>
                            <button type="reset" class="btn-secondary">é‡ç½®è¡¨å•</button>
                        </form>
                        
                        <div id="loading" class="loading">
                            <div class="spinner"></div>
                            <p>æ­£åœ¨æäº¤...</p>
                        </div>
                        
                        <div id="result" class="alert"></div>
                    </div>
                    
                    <div>
                        <h2>ä½¿ç”¨è¯´æ˜</h2>
                        <div class="stats">
                            <h3>ğŸ“Š æœ¬åœ°ç»Ÿè®¡</h3>
                            <p>æœ¬åœ°è®°å½•æ•°: <span id="localRecords">0</span></p>
                            <p>ä»Šæ—¥æäº¤: <span id="todayRecords">0</span></p>
                            <p>æœ€åæäº¤: <span id="lastSubmit">ä»æœª</span></p>
                        </div>
                        
                        <div class="stats" style="margin-top: 20px;">
                            <h3>ğŸŒ äº‘ç«¯çŠ¶æ€</h3>
                            <p id="apiStatus">APIçŠ¶æ€: <span id="apiStatusText">æ£€æµ‹ä¸­...</span></p>
                            <p>å­˜å‚¨æ¨¡å¼: <span id="storageModeText">äº‘ç«¯+æœ¬åœ°</span></p>
                        </div>
                        
                        <div class="stats" style="margin-top: 20px;">
                            <h3>ğŸ’¡ åŠŸèƒ½ä»‹ç»</h3>
                            <p><strong>äº‘ç«¯å­˜å‚¨ï¼š</strong>æ•°æ®ä¿å­˜åˆ°Notionæ•°æ®åº“</p>
                            <p><strong>æœ¬åœ°å¤‡ä»½ï¼š</strong>æ•°æ®åŒæ—¶ä¿å­˜åœ¨æµè§ˆå™¨ä¸­</p>
                            <p><strong>ç¦»çº¿ä½¿ç”¨ï¼š</strong>ç½‘ç»œå¼‚å¸¸æ—¶å¯ä½¿ç”¨æœ¬åœ°æ¨¡å¼</p>
                            <p><strong>æ•°æ®å¯¼å‡ºï¼š</strong>æ”¯æŒå¯¼å‡ºä¸ºCSVæ ¼å¼</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- æœ¬åœ°æ•°æ®ç®¡ç†æ ‡ç­¾é¡µ -->
            <div id="data-tab" class="tab-content">
                <h2>æœ¬åœ°æ•°æ®ç®¡ç†</h2>
                <p>æ­¤é¡µé¢æ•°æ®ä¿å­˜åœ¨æ‚¨çš„æµè§ˆå™¨æœ¬åœ°å­˜å‚¨ä¸­ï¼Œæ¸…é™¤æµè§ˆå™¨æ•°æ®ä¼šä¸¢å¤±è¿™äº›è®°å½•ã€‚</p>
                
                <div class="data-actions">
                    <button id="refreshData" class="btn-primary">åˆ·æ–°æ•°æ®</button>
                    <button id="exportData" class="btn-secondary">å¯¼å‡ºCSV</button>
                    <button id="clearData" class="btn-danger">æ¸…ç©ºæœ¬åœ°æ•°æ®</button>
                    <button id="uploadCloud" class="btn-success">ä¸Šä¼ åˆ°äº‘ç«¯</button>
                </div>
                
                <div id="localDataDisplay">
                    <p>æš‚æ— æœ¬åœ°æ•°æ®</p>
                </div>
                
                <div class="stats" style="margin-top: 20px;">
                    <h3>æœ¬åœ°å­˜å‚¨ä¿¡æ¯</h3>
                    <p>æ€»è®°å½•æ•°: <span id="localTotalRecords">0</span></p>
                    <p>å­˜å‚¨å¤§å°: <span id="localStorageSize">0 KB</span></p>
                    <p>æ•°æ®å¤‡ä»½: <span id="backupStatus">æœªå¤‡ä»½</span></p>
                </div>
            </div>
            
            <!-- äº‘ç«¯çŠ¶æ€æ ‡ç­¾é¡µ -->
            <div id="cloud-tab" class="tab-content">
                <h2>äº‘ç«¯çŠ¶æ€</h2>
                
                <div class="stats">
                    <h3>ğŸŒ äº‘ç«¯è¿æ¥</h3>
                    <p id="cloudStatusDetail">çŠ¶æ€: æ£€æµ‹ä¸­...</p>
                    <p id="cloudApiStatus">API: æ£€æµ‹ä¸­...</p>
                    <p id="cloudConfigStatus">é…ç½®: æ£€æµ‹ä¸­...</p>
                </div>
                
                <div class="stats" style="margin-top: 20px;">
                    <h3>ğŸ“¤ äº‘ç«¯æ“ä½œ</h3>
                    <p>äº‘ç«¯æäº¤: <span id="cloudSubmitCount">0</span> æ¬¡</p>
                    <p>æœ€åæäº¤: <span id="cloudLastSubmit">ä»æœª</span></p>
                    <p>åŒæ­¥çŠ¶æ€: <span id="syncStatus">æœªå¼€å§‹</span></p>
                </div>
                
                <div style="margin-top: 20px;">
                    <button id="testCloud" class="btn-primary">æµ‹è¯•äº‘ç«¯è¿æ¥</button>
                    <button id="syncAll" class="btn-success">åŒæ­¥å…¨éƒ¨åˆ°äº‘ç«¯</button>
                </div>
                
                <div id="cloudResult" class="alert" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
     
       const API_BASE_URL = window.location.origin.includes('localhost') 
        ? 'http://localhost:3000/api' 
         : window.location.origin + '/api';
            
        let cloudStats = {
            submitCount: 0,
            lastSubmit: null,
            connectionTested: false
        };
        
        document.addEventListener('DOMContentLoaded', function() {
            // è®¾ç½®é»˜è®¤æ—¥æœŸä¸ºæ˜¨å¤©
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayStr = yesterday.toISOString().split('T')[0];
            document.getElementById('date').value = yesterdayStr;
            
            // åˆå§‹åŒ–æ ‡ç­¾é¡µç³»ç»Ÿ
            initTabSystem();
            
            // æµ‹è¯•APIè¿æ¥
            testApiConnection();
            
            // è¡¨å•æäº¤
            document.getElementById('homeworkForm').addEventListener('submit', function(e) {
                e.preventDefault();
                submitRecord();
            });
            
            // æŒ‰é’®äº‹ä»¶ç»‘å®š
            document.getElementById('refreshData').addEventListener('click', loadLocalData);
            document.getElementById('exportData').addEventListener('click', exportLocalData);
            document.getElementById('clearData').addEventListener('click', clearLocalData);
            document.getElementById('uploadCloud').addEventListener('click', uploadToCloud);
            document.getElementById('testCloud').addEventListener('click', testCloudConnection);
            document.getElementById('syncAll').addEventListener('click', syncAllToCloud);
            
            // é‡ç½®æŒ‰é’®
            document.querySelector('button[type="reset"]').addEventListener('click', function() {
                document.getElementById('date').value = yesterdayStr;
            });
            
            // ç›‘å¬å­˜å‚¨æ¨¡å¼å˜åŒ–
            document.getElementById('storageMode').addEventListener('change', updateStorageModeText);
            
            updateStorageModeText();
            
            // åˆå§‹åŒ–äº‘ç«¯ç»Ÿè®¡
            loadCloudStats();
            
            // åŠ è½½æœ¬åœ°æ•°æ®
            loadLocalData();
        });
        
        // æ ‡ç­¾é¡µç³»ç»Ÿ
        function initTabSystem() {
            const tabs = document.querySelectorAll('.tab');
            const tabContents = document.querySelectorAll('.tab-content');
            
            tabs.forEach(tab => {
                tab.addEventListener('click', function() {
                    const tabId = this.getAttribute('data-tab');
                    
                    // ç§»é™¤æ‰€æœ‰activeç±»
                    tabs.forEach(t => t.classList.remove('active'));
                    tabContents.forEach(c => c.classList.remove('active'));
                    
                    // æ·»åŠ activeç±»åˆ°å½“å‰æ ‡ç­¾
                    this.classList.add('active');
                    document.getElementById(`${tabId}-tab`).classList.add('active');
                    
                    // æ‰§è¡Œæ ‡ç­¾é¡µç‰¹å®šæ“ä½œ
                    if (tabId === 'data') {
                        setTimeout(loadLocalData, 100);
                    } else if (tabId === 'cloud') {
                        setTimeout(updateCloudStatus, 100);
                    }
                });
            });
        }
        
        // æ›´æ–°å­˜å‚¨æ¨¡å¼æ˜¾ç¤º
        function updateStorageModeText() {
            const mode = document.getElementById('storageMode').value;
            let text = '';
            switch(mode) {
                case 'both': text = 'äº‘ç«¯+æœ¬åœ°'; break;
                case 'cloud': text = 'ä»…äº‘ç«¯'; break;
                case 'local': text = 'ä»…æœ¬åœ°'; break;
            }
            document.getElementById('storageModeText').textContent = text;
        }
        
        // æµ‹è¯•APIè¿æ¥
        async function testApiConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/test`, {
                    method: 'GET'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    document.getElementById('apiStatusText').textContent = 'âœ… è¿æ¥æ­£å¸¸';
                    document.getElementById('apiStatusText').style.color = '#2E7D32';
                    document.getElementById('statusText').textContent = 'äº‘ç«¯è¿æ¥æ­£å¸¸';
                    document.getElementById('statusIcon').textContent = 'ğŸŒ';
                    document.getElementById('cloudStatus').className = 'cloud-status online';
                    
                    // æ›´æ–°äº‘ç«¯çŠ¶æ€
                    document.getElementById('cloudApiStatus').textContent = 'API: âœ… æ­£å¸¸';
                    document.getElementById('cloudConfigStatus').textContent = 'é…ç½®: âœ… å·²é…ç½®';
                } else {
                    updateApiStatusError();
                }
            } catch (error) {
                updateApiStatusError();
            }
        }
        
        function updateApiStatusError() {
            document.getElementById('apiStatusText').textContent = 'âŒ è¿æ¥å¤±è´¥';
            document.getElementById('apiStatusText').style.color = '#c62828';
            document.getElementById('statusText').textContent = 'äº‘ç«¯è¿æ¥å¤±è´¥ï¼Œå°†ä½¿ç”¨æœ¬åœ°æ¨¡å¼';
            document.getElementById('statusIcon').textContent = 'âš ï¸';
            document.getElementById('cloudStatus').className = 'cloud-status offline';
            
            // æ›´æ–°äº‘ç«¯çŠ¶æ€
            document.getElementById('cloudApiStatus').textContent = 'API: âŒ å¤±è´¥';
            document.getElementById('cloudConfigStatus').textContent = 'é…ç½®: âŒ æœªé…ç½®';
        }
        
        // æäº¤è®°å½•
        async function submitRecord() {
            const record = {
                date: document.getElementById('date').value,
                name: document.getElementById('name').value.trim(),
                nineWord: parseInt(document.getElementById('nineWord').value) || 0,
                buddhaWorship: parseInt(document.getElementById('buddhaWorship').value) || 0,
                quietZen: parseInt(document.getElementById('quietZen').value) || 0,
                activeZen: parseInt(document.getElementById('activeZen').value) || 0,
                diamond: parseInt(document.querySelector('input[name="diamond"]:checked').value) || 0,
                amitabha: parseInt(document.querySelector('input[name="amitabha"]:checked').value) || 0,
                guanyin: parseInt(document.querySelector('input[name="guanyin"]:checked').value) || 0,
                puxian: parseInt(document.querySelector('input[name="puxian"]:checked').value) || 0,
                dizang: parseInt(document.querySelector('input[name="dizang"]:checked').value) || 0,
                yaoshi: parseInt(document.querySelector('input[name="yaoshi"]:checked').value) || 0,
                remark: document.getElementById('remark').value.trim(),
                deviceId: 'web',
                submitTime: new Date().toLocaleString('zh-CN'),
                submitTimestamp: Date.now(),
                storageMode: document.getElementById('storageMode').value
            };
            
            // éªŒè¯
            if (!record.date || !record.name) {
                showResult('è¯·å¡«å†™æ—¥æœŸå’Œå§“å', 'error', 'result');
                return;
            }
            
            // è®¡ç®—ç»å…¸æ€»æ•°ï¼ˆåŒ…å«è¯å¸ˆä½›ç»ï¼‰
            const classicsTotal = record.diamond + record.amitabha + record.guanyin + 
                                record.puxian + record.dizang + record.yaoshi;
            let resultMessage = '';
            let success = false;
            
            // æ˜¾ç¤ºåŠ è½½ä¸­
            document.getElementById('loading').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            
            const storageMode = document.getElementById('storageMode').value;
            
            try {
                // æ ¹æ®æ¨¡å¼ä¿å­˜æ•°æ®
                if (storageMode === 'local' || storageMode === 'both') {
                    // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
                    const localSuccess = saveToLocal(record);
                    if (localSuccess) {
                        resultMessage += 'âœ… æœ¬åœ°ä¿å­˜æˆåŠŸï¼<br>';
                        success = true;
                    } else {
                        resultMessage += 'âš ï¸ æœ¬åœ°ä¿å­˜å¤±è´¥<br>';
                    }
                }
                
                if (storageMode === 'cloud' || storageMode === 'both') {
                    // ä¿å­˜åˆ°äº‘ç«¯
                    try {
                        const response = await fetch(`${API_BASE_URL}/submit`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            body: JSON.stringify(record)
                        });
                        
                        const data = await response.json();
                        
                        if (data.success) {
                            resultMessage += 'â˜ï¸ äº‘ç«¯ä¿å­˜æˆåŠŸï¼<br>';
                            success = true;
                            
                            // æ›´æ–°äº‘ç«¯ç»Ÿè®¡
                            cloudStats.submitCount++;
                            cloudStats.lastSubmit = new Date().toLocaleString('zh-CN');
                            saveCloudStats();
                        } else {
                            resultMessage += `âš ï¸ äº‘ç«¯ä¿å­˜å¤±è´¥: ${data.error || 'æœªçŸ¥é”™è¯¯'}<br>`;
                        }
                    } catch (cloudError) {
                        resultMessage += `âš ï¸ äº‘ç«¯è¿æ¥å¤±è´¥: ${cloudError.message}<br>`;
                    }
                }
                
                if (success) {
                    resultMessage += `<br>ğŸ“‹ ${record.name} - ${record.date}<br>`;
                    resultMessage += `ğŸ“š ç»å…¸è¯µè¯»: ${classicsTotal}é<br>`;
                    resultMessage += `â° ${record.submitTime}`;
                    
                    showResult(resultMessage, 'success', 'result');
                    
                    // åˆ·æ–°æ•°æ®
                    loadLocalData();
                    updateCloudStatus();
                    
                    // æ¸…ç©ºè¡¨å•ï¼ˆä¿ç•™æ—¥æœŸï¼‰
                    setTimeout(() => {
                        document.getElementById('homeworkForm').reset();
                        // è®¾ç½®æ—¥æœŸä¸ºæ˜¨å¤©
                        const yesterday = new Date();
                        yesterday.setDate(yesterday.getDate() - 1);
                        document.getElementById('date').value = yesterday.toISOString().split('T')[0];
                        document.getElementById('nineWord').value = 0;
                        document.getElementById('buddhaWorship').value = 0;
                        document.getElementById('quietZen').value = 0;
                        document.getElementById('activeZen').value = 0;
                        document.getElementById('storageMode').value = 'both';
                        updateStorageModeText();
                        document.getElementById('result').style.display = 'none';
                    }, 5000);
                } else {
                    showResult('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œè¿æ¥æˆ–å°è¯•æœ¬åœ°æ¨¡å¼', 'error', 'result');
                }
                
            } catch (error) {
                showResult(`æäº¤å¤±è´¥: ${error.message}`, 'error', 'result');
            } finally {
                // éšè—åŠ è½½ä¸­
                document.getElementById('loading').style.display = 'none';
            }
        }
        
        // ä¿å­˜åˆ°æœ¬åœ°å­˜å‚¨
        function saveToLocal(record) {
            try {
                let records = JSON.parse(localStorage.getItem('homeworkRecords')) || [];
                record.localId = 'local_' + Date.now();
                records.push(record);
                localStorage.setItem('homeworkRecords', JSON.stringify(records));
                return true;
            } catch (error) {
                console.error('æœ¬åœ°ä¿å­˜å¤±è´¥:', error);
                return false;
            }
        }
        
        // åŠ è½½æœ¬åœ°æ•°æ®
        function loadLocalData() {
            const records = JSON.parse(localStorage.getItem('homeworkRecords')) || [];
            
            // æ›´æ–°ç»Ÿè®¡
            document.getElementById('localRecords').textContent = records.length;
            document.getElementById('localTotalRecords').textContent = records.length;
            
            // è®¡ç®—å­˜å‚¨å¤§å°
            const storageSize = JSON.stringify(records).length;
            document.getElementById('localStorageSize').textContent = (storageSize / 1024).toFixed(2) + ' KB';
            
            // è®¡ç®—ä»Šæ—¥æäº¤
            const today = new Date().toISOString().split('T')[0];
            const todayCount = records.filter(r => r.date === today).length;
            document.getElementById('todayRecords').textContent = todayCount;
            
            if (records.length > 0) {
                const lastRecord = records[records.length - 1];
                document.getElementById('lastSubmit').textContent = `${lastRecord.name} - ${lastRecord.submitTime}`;
                
                // æ£€æŸ¥å¤‡ä»½çŠ¶æ€
                const cloudRecords = records.filter(r => r.storageMode === 'cloud' || r.storageMode === 'both');
                document.getElementById('backupStatus').textContent = `${cloudRecords.length}/${records.length} å·²å¤‡ä»½`;
            } else {
                document.getElementById('lastSubmit').textContent = 'ä»æœª';
                document.getElementById('backupStatus').textContent = 'æœªå¤‡ä»½';
            }
            
            // æ˜¾ç¤ºæ•°æ®
            const displayDiv = document.getElementById('localDataDisplay');
            
            if (records.length === 0) {
                displayDiv.innerHTML = '<p>æš‚æ— æœ¬åœ°æ•°æ®</p>';
                return;
            }
            
            let html = '<table class="data-table">';
            html += '<tr><th>æ—¥æœŸ</th><th>å§“å</th><th>ä¹å­—ç¦…</th><th>æ‹œå¿æ–‡</th><th>é™ç¦…</th><th>åŠ¨ç¦…</th><th>é‡‘åˆšç»</th><th>é˜¿å¼¥é™€ç»</th><th>æ™®é—¨å“</th><th>æ™®è´¤å“</th><th>åœ°è—ç»</th><th>è¯å¸ˆç»</th><th>ç»å…¸æ€»æ•°</th><th>å­˜å‚¨æ–¹å¼</th><th>æäº¤æ—¶é—´</th></tr>';
            
            // æ˜¾ç¤ºæœ€è¿‘20æ¡è®°å½•
            records.slice(-20).reverse().forEach(record => {
                // è®¡ç®—ç»å…¸æ€»æ•°ï¼ˆåŒ…å«è¯å¸ˆä½›ç»ï¼‰
                const total = (record.diamond || 0) + (record.amitabha || 0) + (record.guanyin || 0) + 
                             (record.puxian || 0) + (record.dizang || 0) + (record.yaoshi || 0);
                let storageModeText = '';
                switch(record.storageMode) {
                    case 'both': storageModeText = 'ğŸŒ+ğŸ’¾'; break;
                    case 'cloud': storageModeText = 'ğŸŒ'; break;
                    case 'local': storageModeText = 'ğŸ’¾'; break;
                    default: storageModeText = 'ğŸ’¾';
                }
                
                html += `
                    <tr>
                        <td>${record.date}</td>
                        <td>${record.name}</td>
                        <td>${record.nineWord || 0}</td>
                        <td>${record.buddhaWorship || 0}</td>
                        <td>${record.quietZen || 0}</td>
                        <td>${record.activeZen || 0}</td>
                        <td>${record.diamond || 0}</td>
                        <td>${record.amitabha || 0}</td>
                        <td>${record.guanyin || 0}</td>
                        <td>${record.puxian || 0}</td>
                        <td>${record.dizang || 0}</td>
                        <td>${record.yaoshi || 0}</td>
                        <td><strong>${total}</strong></td>
                        <td>${storageModeText}</td>
                        <td>${record.submitTime}</td>
                    </tr>
                `;
            });
            
            html += '</table>';
            displayDiv.innerHTML = html;
        }
        
        // å¯¼å‡ºæœ¬åœ°æ•°æ®
        function exportLocalData() {
            const records = JSON.parse(localStorage.getItem('homeworkRecords')) || [];
            
            if (records.length === 0) {
                alert('æ²¡æœ‰æœ¬åœ°æ•°æ®å¯å¯¼å‡º');
                return;
            }
            
            // CSVæ ¼å¼
            let csv = 'æ—¥æœŸ,å§“å,ä¹å­—ç¦…(å£°),æ‹œå¿æ–‡(é),é™ç¦…(åˆ†é’Ÿ),åŠ¨ç¦…(åˆ†é’Ÿ),é‡‘åˆšç»,é˜¿å¼¥é™€ç»,æ™®é—¨å“,æ™®è´¤å“,åœ°è—ç»,è¯å¸ˆç»,ç»å…¸æ€»æ•°,å¤‡æ³¨,æäº¤æ—¶é—´,å­˜å‚¨æ–¹å¼\n';
            
            records.forEach(record => {
                // è®¡ç®—ç»å…¸æ€»æ•°ï¼ˆåŒ…å«è¯å¸ˆä½›ç»ï¼‰
                const total = (record.diamond || 0) + (record.amitabha || 0) + (record.guanyin || 0) + 
                             (record.puxian || 0) + (record.dizang || 0) + (record.yaoshi || 0);
                csv += `${record.date},${record.name},${record.nineWord},${record.buddhaWorship},${record.quietZen},${record.activeZen},${record.diamond},${record.amitabha},${record.guanyin},${record.puxian},${record.dizang},${record.yaoshi || 0},${total},"${record.remark || ''}",${record.submitTime},${record.storageMode || 'local'}\n`;
            });
            
            // ä¸‹è½½CSV
            const blob = new Blob(['\uFEFF' + csv], { type: 'text/csv;charset=utf-8;' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `åŠŸè¯¾è®°å½•_${new Date().toISOString().split('T')[0]}.csv`;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        // æ¸…ç©ºæœ¬åœ°æ•°æ®
        function clearLocalData() {
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æœ¬åœ°æ•°æ®å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ’¤é”€ï¼')) {
                localStorage.removeItem('homeworkRecords');
                loadLocalData();
                showResult('æœ¬åœ°æ•°æ®å·²æ¸…ç©º', 'success', 'result');
            }
        }
        
        // ä¸Šä¼ åˆ°äº‘ç«¯
        async function uploadToCloud() {
            const records = JSON.parse(localStorage.getItem('homeworkRecords')) || [];
            const localOnlyRecords = records.filter(r => r.storageMode === 'local' || !r.storageMode);
            
            if (localOnlyRecords.length === 0) {
                showResult('æ²¡æœ‰éœ€è¦ä¸Šä¼ çš„æœ¬åœ°æ•°æ®', 'info', 'cloudResult');
                return;
            }
            
            showResult(`å¼€å§‹ä¸Šä¼  ${localOnlyRecords.length} æ¡æœ¬åœ°æ•°æ®åˆ°äº‘ç«¯...`, 'info', 'cloudResult');
            
            let successCount = 0;
            let errorCount = 0;
            
            for (let i = 0; i < localOnlyRecords.length; i++) {
                const record = localOnlyRecords[i];
                
                try {
                    const response = await fetch(`${API_BASE_URL}/submit`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({
                            ...record,
                            storageMode: 'both' // æ›´æ–°ä¸ºåŒé‡å­˜å‚¨
                        })
                    });
                    
                    const data = await response.json();
                    
                    if (data.success) {
                        successCount++;
                        // æ›´æ–°æœ¬åœ°è®°å½•çš„å­˜å‚¨æ¨¡å¼
                        updateLocalRecordStorageMode(record.localId, 'both');
                    } else {
                        errorCount++;
                    }
                    
                    // æ›´æ–°è¿›åº¦
                    const progress = Math.round((i + 1) / localOnlyRecords.length * 100);
                    showResult(`ä¸Šä¼ ä¸­... ${progress}% (${successCount}æˆåŠŸ, ${errorCount}å¤±è´¥)`, 'info', 'cloudResult');
                } catch (error) {
                    errorCount++;
                }
            }
            
            showResult(`ä¸Šä¼ å®Œæˆï¼æˆåŠŸ: ${successCount}æ¡ï¼Œå¤±è´¥: ${errorCount}æ¡`, 
                      errorCount === 0 ? 'success' : 'error', 'cloudResult');
            
            // åˆ·æ–°æ•°æ®
            loadLocalData();
        }
        
        // æ›´æ–°æœ¬åœ°è®°å½•çš„å­˜å‚¨æ¨¡å¼
        function updateLocalRecordStorageMode(localId, newMode) {
            let records = JSON.parse(localStorage.getItem('homeworkRecords')) || [];
            records = records.map(record => {
                if (record.localId === localId) {
                    return { ...record, storageMode: newMode };
                }
                return record;
            });
            localStorage.setItem('homeworkRecords', JSON.stringify(records));
        }
        
        // æµ‹è¯•äº‘ç«¯è¿æ¥
        async function testCloudConnection() {
            try {
                const response = await fetch(`${API_BASE_URL}/test`, {
                    method: 'GET'
                });
                
                const data = await response.json();
                
                if (data.success) {
                    showResult('âœ… äº‘ç«¯è¿æ¥æµ‹è¯•æˆåŠŸï¼', 'success', 'cloudResult');
                    document.getElementById('cloudStatusDetail').textContent = 'çŠ¶æ€: âœ… æ­£å¸¸';
                    cloudStats.connectionTested = true;
                    saveCloudStats();
                } else {
                    showResult(`âŒ è¿æ¥å¤±è´¥: ${data.error}`, 'error', 'cloudResult');
                    document.getElementById('cloudStatusDetail').textContent = 'çŠ¶æ€: âŒ å¤±è´¥';
                }
            } catch (error) {
                showResult(`âŒ è¿æ¥å¤±è´¥: ${error.message}`, 'error', 'cloudResult');
                document.getElementById('cloudStatusDetail').textContent = 'çŠ¶æ€: âŒ å¤±è´¥';
            }
        }
        
        // åŒæ­¥å…¨éƒ¨åˆ°äº‘ç«¯
        async function syncAllToCloud() {
            await uploadToCloud();
        }
        
        // æ›´æ–°äº‘ç«¯çŠ¶æ€
        function updateCloudStatus() {
            loadCloudStats();
            document.getElementById('cloudSubmitCount').textContent = cloudStats.submitCount;
            document.getElementById('cloudLastSubmit').textContent = cloudStats.lastSubmit || 'ä»æœª';
            document.getElementById('syncStatus').textContent = cloudStats.connectionTested ? 'å·²è¿æ¥' : 'æœªè¿æ¥';
        }
        
        // åŠ è½½äº‘ç«¯ç»Ÿè®¡
        function loadCloudStats() {
            const saved = localStorage.getItem('cloudStats');
            if (saved) {
                cloudStats = JSON.parse(saved);
            }
        }
        
        // ä¿å­˜äº‘ç«¯ç»Ÿè®¡
        function saveCloudStats() {
            localStorage.setItem('cloudStats', JSON.stringify(cloudStats));
        }
        
        // æ˜¾ç¤ºç»“æœ
        function showResult(message, type, elementId = 'result') {
            const resultDiv = document.getElementById(elementId);
            
            resultDiv.innerHTML = message;
            resultDiv.className = `alert alert-${type}`;
            
            resultDiv.style.display = 'block';
            
            // è‡ªåŠ¨éšè—
            if (type !== 'info') {
                setTimeout(() => {
                    resultDiv.style.display = 'none';
                }, 5000);
            }
        }
    </script>
</body>
</html>
